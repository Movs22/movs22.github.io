<!DOCTYPE html>
<html>

<head>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-N4D2MS3MLF');
    </script>
    <meta charset="UTF-8">
    <link href="style.css" rel="stylesheet">
    <title>Horários em tempo real - </title>
    <link rel="icon" href="/cm-icon.png?" sizes="256x256">
</head>

<body>
    <div id="cookie-banner">
        <p>Este site utiliza cookies para recolha de estatísticas, de forma anónima.<br>Aceita a utilização de cookies para este fim?</p>
            <button id="accept-cookies">Aceitar</button>
            <button id="decline-cookies">Recusar</button>
    </div>
    <div class="contents">
        <div class="header" id="header">
            <strong>{STOP.NAME}</strong>
        </div>
        <div class="info" id="info">
            <strong>Linhas: </strong>{STOP.LINES}
            <strong>Concelho: </strong>{STOP.MUNICIPALITY}
            <p>Todos os dados apresentados foram obtidos através da <a
                    href="https://github.com/carrismetropolitana/api">API da Carris Metropolitana</a>.</p>
                    <p>Para saber mais sobre este site, clique <a
                        href="/carrismetropolitana/">aqui</a>.</p>
        </div>
        <div class="departures">
            <p><strong>Próximos autocarros:</strong></p>
            <div class="services" id="services">
                Carregando...
            </div>
        </div>
    </div>

    <!-- Cookie Banner -->
    <script>
        const banner = document.getElementById('cookie-banner');
        const acceptButton = document.getElementById('accept-cookies');
        const declineButton = document.getElementById('decline-cookies');

        // Check if cookies have already been accepted
        const hasConsent = localStorage.getItem('cookieConsent');

        if (hasConsent === 'true') {
            loadGoogleAnalytics();
            banner.style.display = 'none';
        } else if (hasConsent === 'false') {
            banner.style.display = 'none';
        }

        // Event listeners for the buttons
        acceptButton.addEventListener('click', () => {
            localStorage.setItem('cookieConsent', 'true');
            banner.style.display = 'none';
            loadGoogleAnalytics();
        });

        declineButton.addEventListener('click', () => {
            localStorage.setItem('cookieConsent', 'false');
            banner.style.display = 'none';
        });

        // Load Google Analytics only with consent
        function loadGoogleAnalytics() {
            const script = document.createElement('script');
            script.async = true;
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-N4D2MS3MLF';
            document.head.appendChild(script);

            script.onload = () => {
                window.dataLayer = window.dataLayer || [];
                function gtag() { dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'G-N4D2MS3MLF');
            };
        }
    </script>

    <script>
        let interval;

        let colorCache = {}

	let patternsCache = {};

        let routeCache = {};

        document.body.onload = () => {
            let url = window.location.href.split("/")
            let stopId = url[url.length - 1]
            fetch("https://api.carrismetropolitana.pt/stops/" + stopId).then(async r => {
                document.querySelector("link[rel*='icon']").href = "/cm-icon.png";
                if (!r.ok) return window.location.href = "/cmetropolitana/not-found"
                r = await r.json()
                if (Object.keys(r).length === 0) return window.location.href = "/cmetropolitana/not-found"
                document.getElementById("header").innerHTML = "<strong>" + r.name + "</strong>"
                document.title = "Horários em tempo real - " + r.name
                let lines = ""
                for await (const line of r.lines) {
                    let a = await fetch("https://api.carrismetropolitana.pt/lines/" + line).then(r => r.json())
                    lines = lines + "<span class=\"line\" style=\"background-color: " + a.color + "\">" + line + "</span>"
                    colorCache[line] = a.color;
                }
                document.getElementById("info").innerHTML = "<p><strong>Linhas: </strong>" + lines + "</p><p><strong>Concelho: </strong>" + (r.municipality_name || "Por definir") + "</p><p>Todos os dados apresentados foram obtidos através da <a href=\"https://github.com/carrismetropolitana/api\">API da Carris Metropolitana</a>.</p><p>Para saber mais sobre este site, clique <a href=\"/cmetropolitana/\">aqui</a>.</p>"
		
                await fetchBuses(stopId)
                interval = setInterval(async () => {
                    await fetchBuses(stopId)
                }, 60 * 1000)
            }).catch(error => {
		        console.log(error)
                window.location.href = "/cmetropolitana/not-found"
            });
        }

        document.body.onclose = interval ? clearInterval(interval) : true


        let selectedVec;

        async function fetchBuses(id) {
	    let vehicles = await fetch("https://api.carrismetropolitana.pt/vehicles").then(r => r.json())
            routeCache = null;
            let now = Date.now() / 1000
            let res = await fetch("https://api.carrismetropolitana.pt/stops/" + id + "/realtime").then(r => r.json())
            res = res.filter(a => (a.estimated_arrival_unix > (now-30*60) || a.scheduled_arrival_unix > (now-30*60)) && !a.observed_arrival_unix)
		
            res.sort((a, b) => (a.estimated_arrival_unix ? a.estimated_arrival_unix : a.scheduled_arrival_unix) - (b.estimated_arrival_unix ? b.estimated_arrival_unix : b.scheduled_arrival_unix))

            res = res.slice(0, 60)

	    for(let b in res) {
            if(patternsCache[res[b].pattern_id]) continue;
	    	let p = await fetch("../patterns/" + res[b].pattern_id + ".json").then(r => r.json())
		patternsCache[res[b].pattern_id] = p;
	    }

	    res.forEach(bus => {
	    	if(!bus.estimated_arrival) {
			let vehicle = vehicles.find(a => a.trip_id === bus.trip_id)
			if(vehicle) {
				let route = patternsCache[vehicle.pattern_id]
				let rS = route.path.indexOf(route.path.find(a => a.id === vehicle.stop_id))
				let rE = route.path.indexOf(route.path.find(a => a.id === id && a.index === bus.stop_sequence))
                if(rE < rS) bus.observed_arrival_unix = Date.now()
				let section = route.path.filter(a => route.path.indexOf(a) >= rS && route.path.indexOf(a) <= rE)
				let time = 0;
				section.forEach(arr => time += arr.schedule.travel_time)
				if(rS > 0) {
					bus.estimated_arrival_unix = vehicle.timestamp + time*60;
					bus.estimated_arrival = (new Date(bus.estimated_arrival_unix * 1000).toTimeString().split(' ')[0])
				}
				bus.vehicle_id = vehicle.id
			}
		}
	    })
	
        res = res.filter(a => (a.estimated_arrival_unix > (now) || a.scheduled_arrival_unix > (now)) && !a.observed_arrival_unix)
        res = res.slice(0, 25)
	    res.sort((a, b) => (a.estimated_arrival_unix ? a.estimated_arrival_unix : a.scheduled_arrival_unix) - (b.estimated_arrival_unix ? b.estimated_arrival_unix : b.scheduled_arrival_unix))

            routeCache = res;

            let prevSelected;

            let response = ""
            document.getElementById("services").innerHTML = ""
            res.forEach(bus => {
                let arrival = "";
                let delay = "";

                let arrivalSpan = "scheduled";
                if (bus.estimated_arrival) {
                    let dif = bus.estimated_arrival_unix - Date.now() / 1000
                    dif = Math.floor(dif / 60)
                    if (dif < 1) {
                        arrival = "A chegar | "
                    } else {
                        if (dif > 59) {
                            dif = Math.floor(dif / 60)
                            arrival = dif + " h" + (dif === 1 ? "" : "s") + " | "
                        } else {
                            arrival = dif + " min" + (dif === 1 ? "" : "s") + " | "
                        }
                    }
                    let dif2 = bus.estimated_arrival_unix - bus.scheduled_arrival_unix
                    dif2 = Math.floor(dif2 / 60)

                    if (dif2 === 0) {
                        delay = "No horário previsto"
                        arrivalSpan = "ontime"
                    } else {
                        delay = Math.abs(dif2) + " minuto" + (Math.abs(dif2) === 1 ? " " : "s ") + (dif2 < 0 ? "adiantado" : "atrasado")
                        arrivalSpan = dif2 < 0 ? "early" : "delayed"
                        arrival = arrival + "<span class=\"prevTime\">" + bus.scheduled_arrival.split(":").slice(0, -1).join(":") + "</span> "
                    }
                } else {
                    delay = "Planeado"
                }
                arrival += "<span class=\"" + arrivalSpan + "\">" + (bus.estimated_arrival ? bus.estimated_arrival.split(":").slice(0, -1).join(":") : bus.scheduled_arrival.split(":").slice(0, -1).join(":")) + "</span>";
                arrival = arrival.replaceAll("24:", "(+1) 00:").replaceAll("25:", "(+1) 01:")
                let div = document.createElement("div")
                div.classList.add("service")
                div.setAttribute("trip-id", bus.trip_id + "&" + bus.stop_sequence)
                div.setAttribute("route-id", bus.pattern_id)
                div.setAttribute("stop-sequence", bus.stop_sequence)
                div.onclick = () => {
                    if (div.classList.contains("selected")) {
                        div.classList.remove("selected");
                        prevSelected = undefined
                        selectedVec = undefined
                    } else {
                        prevSelected ? prevSelected.classList.remove("selected") : null
                        div.classList.add("selected")
                        prevSelected = div;
                        selectedVec = bus.trip_id + "&" + bus.stop_sequence
                        if(document.getElementById("currentStop")) document.getElementById("currentStop").removeAttribute("id")
                        loadRoute(div)
                    }
                }

                div.innerHTML = "<div class=\"serviceUpper\"><p class=\"dest\"><span class=\"line\" style=\"background-color: " + colorCache[bus.line_id] + "\">" + bus.line_id + "</span><strong>" + bus.headsign + "</strong></p><p class=\"arrival\">" + arrival + "</p></div><div class=\"serviceLower\"><p class=\"desc\">" + (getVehicle(bus.vehicle_id) !== "Desconhecido" ? "Tipo de veículo: <strong>" + getVehicle(bus.vehicle_id) + "</strong>" : "") + "</p><p class=\"delay\">" + delay + "</p></div><div class=\"route\" id=\"route-" + bus.trip_id + "&" + bus.stop_sequence + "\"><div class=\"stops\" id=\"stops-" + bus.trip_id + "&" + bus.stop_sequence + "\"></div></div>"
                document.getElementById("services").appendChild(div)
 if (bus.trip_id + "&" + bus.stop_sequence === selectedVec) {
		    selectedVec = bus.trip_id + "&" + bus.stop_sequence
                    if(document.getElementById("currentStop")) document.getElementById("currentStop").removeAttribute("id")
                    div.classList.add("selected"); 
                    prevSelected = div;
    		        loadRoute(div)
                }
            });
            if (res.length === 0) document.getElementById("services").innerHTML = "Não existem serviços para este dia."
        }

        function getVehicle(id) {
            if (!id) return "Desconhecido"
            if (id.startsWith("41|3") || id.startsWith("41|5") || id.startsWith("41|72") || id.startsWith("41|76")) return "Autocarro com 2 portas"
            if (id.startsWith("41|17") || id.startsWith("41|8") || id.startsWith("41|73") || id.startsWith("41|74")) return "Carrinha"
            if (id.startsWith("41|1") && id.length === 7) return "Autocarro com 3 portas"
            return "UNKNOWN (ID: " + id + ")"
        }

        async function loadRoute(div) {
            if(div.getAttribute("loaded")) return;
            div.setAttribute("loaded", "true")
            r = patternsCache[div.getAttribute("route-id")]
                let stopsDiv = document.getElementById("stops-" + div.getAttribute("trip-id"))
                let routeDiv = document.getElementById("route-" + div.getAttribute("trip-id"))
                routeDiv.innerHTML = "<p class=\"routeTitle\">" + r.long_name + "</p>";
                routeDiv.appendChild(stopsDiv)
                if (!stopsDiv) alert("FAILED")
                let route = routeCache.find(a => a.trip_id + "&" + a.stop_sequence === div.getAttribute("trip-id"))
                let time = route.estimated_arrival || route.scheduled_arrival;
                let time2 = route.scheduled_arrival.split(":");
                time = time.split(":")
                let h = parseInt(time[0])
                let m = parseInt(time[1])
                let h2 = parseInt(time2[0])
                let m2 = parseInt(time2[1])
                let eta = route.estimated_arrival_unix;
                let stop_sequence = parseInt(div.getAttribute("stop-sequence"))
                let delay = (route.estimated_arrival_unix || 0) - route.scheduled_arrival_unix
                delay = Math.floor(delay / 60) * 60
                await r.path.forEach(stop => {
                    stopDiv = document.createElement("div")
                    let arrival = "";
                    if (stop.index < stop_sequence) {
                        arrival = ""
                    } else if (stop.index === stop_sequence) {
                        let arrivalSpan;
                        if (delay === 0 && route.estimated_arrival) {
                            arrivalSpan = "ontime";
                        } else if(route.estimated_arrival) {
                            arrivalSpan = delay < 0 ? "early" : "delayed"
                            arrival = arrival + "<span class=\"prevTime\">" + (h2 < 10 ? "0" + h2 : (h2 > 23 ? ("(+1) 0" + (h2 - 24)) : h2)) + ":" + (m2 < 10 ? "0" + m2 : m2) + "</span> "
                        }
                        arrival = arrival + "<span class=\"" + arrivalSpan + "\">" + (h < 10 ? "0" + h : (h > 23 ? ("(+1) 0" + (h - 24)) : h)) + ":" + (m < 10 ? "0" + m : m) + "</span> | "
                        stopDiv.id = "currentStop"
                    } else {
                        m += stop.schedule.travel_time
                        m2 += stop.schedule.travel_time
                        if (m > 59) {
                            h += 1
                            m -= 60
                        }
                        if (m2 > 59) {
                            h2 += 1
                            m2 -= 60
                        }
                        let arrivalSpan;
                        if (delay === 0 && route.estimated_arrival) {
                            arrivalSpan = "ontime";
                        } else if(route.estimated_arrival) {
                            arrivalSpan = delay < 0 ? "early" : "delayed"
                            arrival = arrival + "<span class=\"prevTime\">" + (h2 < 10 ? "0" + h2 : (h2 > 23 ? ("(+1) 0" + (h2 - 24)) : h2)) + ":" + (m2 < 10 ? "0" + m2 : m2) + "</span> "
                        }
                        arrival = arrival + "<span class=\"" + arrivalSpan + "\">" + (h < 10 ? "0" + h : (h > 23 ? ("(+1) 0" + (h - 24)) : h)) + ":" + (m < 10 ? "0" + m : m) + "</span> | "
                    }
                    stopDiv.innerHTML = "<p>" + arrival + stop.name + "</p>"
                    stopDiv.classList.add("stop")
                    stopsDiv.appendChild(stopDiv)
                })
                let stopsBefore = window.getComputedStyle(stopsDiv, '::before');
                let totalScrollHeight = stopsDiv.scrollHeight;
                stopsDiv.style.setProperty('--line-height', `${totalScrollHeight}px`);
                stopsDiv.style.setProperty('--pattern-color', r.color);
                document.getElementById("currentStop").scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest'
                });

          
        }
    </script>
</body>

</html>
